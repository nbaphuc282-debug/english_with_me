<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electro Mind - Electrical Engineering Learning</title>
    
    <!-- Font chữ Google -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome cho Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary-color: #6366f1; /* Màu tím xanh chủ đạo */
            --secondary-color: #a855f7; /* Màu tím nhạt */
            --accent-color: #06b6d4; /* Màu xanh cyan */
            --bg-color: #f3f4f6;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --white: #ffffff;
            --success: #10b981;
            --error: #ef4444;
            --gradient-main: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-dark); line-height: 1.5; }
        
        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .btn {
            display: inline-block; padding: 10px 20px; border-radius: 8px; border: none;
            font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center;
        }
        .btn-primary { background: var(--gradient-main); color: var(--white); box-shadow: var(--shadow-md); }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); }
        .btn-danger { background-color: var(--error); color: white; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-dark); }
        .input-field {
            width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;
            font-size: 1rem; transition: border-color 0.2s;
        }
        .input-field:focus { outline: none; border-color: var(--primary-color); ring: 2px solid var(--primary-color); }

        /* --- AUTH SCREEN --- */
        #auth-screen {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            background: url('https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=2070&auto=format&fit=crop') no-repeat center center/cover;
        }
        .auth-card {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 40px;
            border-radius: 20px; width: 100%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .logo-text { font-size: 2rem; font-weight: 800; background: var(--gradient-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        .role-switch { display: flex; background: #e5e7eb; border-radius: 8px; padding: 4px; margin-bottom: 20px; }
        .role-btn { flex: 1; padding: 8px; border-radius: 6px; border: none; background: transparent; font-weight: 600; cursor: pointer; }
        .role-btn.active { background: var(--white); color: var(--primary-color); box-shadow: var(--shadow-sm); }

        /* --- DASHBOARD LAYOUT --- */
        header { background: var(--white); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 100; }
        .navbar { display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .nav-logo { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); display: flex; align-items: center; gap: 10px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-badge { background: #e0e7ff; color: var(--primary-color); padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }

        .main-grid { display: grid; grid-template-columns: 250px 1fr; gap: 30px; padding-top: 30px; padding-bottom: 50px; }
        
        /* Sidebar */
        .sidebar { background: var(--white); border-radius: var(--radius); padding: 20px; height: fit-content; box-shadow: var(--shadow-sm); }
        .menu-item {
            display: flex; align-items: center; gap: 10px; padding: 12px 15px;
            color: var(--text-light); cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: all 0.2s;
        }
        .menu-item:hover, .menu-item.active { background: #eff6ff; color: var(--primary-color); }
        .menu-item i { width: 20px; text-align: center; }

        /* Content Area */
        .content-area { min-height: 500px; }
        .card { background: var(--white); border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow-sm); margin-bottom: 20px; }
        .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; color: var(--text-dark); border-left: 5px solid var(--secondary-color); padding-left: 15px; }

        /* --- SPECIFIC VIEWS --- */
        /* Lesson Grid */
        .lesson-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .lesson-card { background: var(--white); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow-sm); transition: transform 0.2s; border: 1px solid #e5e7eb; display: flex; flex-direction: column; }
        .lesson-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--primary-color); }
        .lesson-img { height: 150px; background: var(--gradient-main); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; }
        .lesson-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        .lesson-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 10px; color: var(--text-dark); }
        .lesson-desc { font-size: 0.9rem; color: var(--text-light); margin-bottom: 15px; flex: 1; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;}

        /* Quiz Game */
        .quiz-container { max-width: 800px; margin: 0 auto; text-align: center; }
        .question-box { font-size: 1.2rem; font-weight: 600; margin: 30px 0; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-btn {
            padding: 20px; border: 2px solid #e5e7eb; border-radius: 10px; background: var(--white);
            font-size: 1rem; cursor: pointer; transition: all 0.2s;
        }
        .option-btn:hover:not(.disabled) { background: #eff6ff; border-color: var(--primary-color); }
        .option-btn.correct { background: #d1fae5 !important; border-color: var(--success) !important; color: #065f46; }
        .option-btn.wrong { background: #fee2e2 !important; border-color: var(--error) !important; color: #991b1b; }
        
        /* Leaderboard */
        .leaderboard-table { width: 100%; border-collapse: collapse; }
        .leaderboard-table th { text-align: left; padding: 15px; background: #f9fafb; color: var(--text-light); font-size: 0.85rem; text-transform: uppercase; }
        .leaderboard-table td { padding: 15px; border-bottom: 1px solid #e5e7eb; }
        .rank-1 { color: #fbbf24; font-weight: bold; }
        .rank-2 { color: #9ca3af; font-weight: bold; }
        .rank-3 { color: #b45309; font-weight: bold; }

        /* Form Creator (Teacher) */
        .form-section { margin-bottom: 20px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; }

        /* Loading & Toast */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .toast {
            position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; background: var(--text-dark);
            color: white; border-radius: 8px; box-shadow: var(--shadow-md); opacity: 0; transition: opacity 0.3s; z-index: 1000;
        }
        .toast.show { opacity: 1; }

        /* Responsive */
        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; padding-top: 20px; }
            .sidebar { margin-bottom: 20px; }
            .options-grid { grid-template-columns: 1fr; }
            .nav-logo span { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <!-- LOADING SPINNER -->
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="toast">Thông báo</div>

    <!-- === 1. AUTHENTICATION SCREEN === -->
    <section id="auth-screen">
        <div class="auth-card">
            <h1 class="logo-text">Electro Mind</h1>
            <p style="margin-bottom: 20px; color: var(--text-light);">HUST Electrical Engineering</p>
            
            <!-- Role Switcher -->
            <div class="role-switch">
                <button class="role-btn active" onclick="switchAuthRole('student')">Sinh viên</button>
                <button class="role-btn" onclick="switchAuthRole('teacher')">Giáo viên</button>
            </div>

            <form id="auth-form">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="email" class="input-field" placeholder="mssv@sis.hust.edu.vn" required>
                </div>
                <div class="input-group">
                    <label>Mật khẩu</label>
                    <input type="password" id="password" class="input-field" placeholder="******" required>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">Đăng nhập</button>
                <button type="button" id="btn-signup" class="btn btn-outline" style="width: 100%;">Đăng ký tài khoản mới</button>
            </form>
        </div>
    </section>

    <!-- === 2. MAIN APP DASHBOARD (Hidden by default) === -->
    <section id="app-dashboard" class="hidden">
        <header>
            <div class="container navbar">
                <div class="nav-logo">
                    <i class="fa-solid fa-bolt"></i>
                    <span>Electro Mind</span>
                </div>
                <div class="user-info">
                    <span class="user-badge" id="user-badge">Student</span>
                    <span id="user-email" style="font-weight: 600; display: none; md:block;">user@email.com</span>
                    <button onclick="handleLogout()" class="btn btn-outline" style="padding: 5px 10px; font-size: 0.9rem;"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
        </header>

        <div class="container main-grid">
            <!-- SIDEBAR -->
            <aside class="sidebar">
                <!-- Menu cho Student -->
                <div id="student-menu" class="hidden">
                    <div class="menu-item active" onclick="navigate('student-lessons')">
                        <i class="fa-solid fa-book-open"></i> Bài học
                    </div>
                    <div class="menu-item" onclick="navigate('student-quiz')">
                        <i class="fa-solid fa-gamepad"></i> Luyện tập (Quiz)
                    </div>
                    <div class="menu-item" onclick="navigate('leaderboard')">
                        <i class="fa-solid fa-trophy"></i> Bảng xếp hạng
                    </div>
                </div>

                <!-- Menu cho Teacher -->
                <div id="teacher-menu" class="hidden">
                    <div class="menu-item active" onclick="navigate('teacher-create-lesson')">
                        <i class="fa-solid fa-pen-to-square"></i> Đăng bài học
                    </div>
                    <div class="menu-item" onclick="navigate('teacher-create-quiz')">
                        <i class="fa-solid fa-circle-question"></i> Tạo câu hỏi
                    </div>
                    <div class="menu-item" onclick="navigate('student-lessons')">
                        <i class="fa-solid fa-eye"></i> Xem bài đăng
                    </div>
                </div>
            </aside>

            <!-- MAIN CONTENT AREA -->
            <main class="content-area">
                
                <!-- VIEW: STUDENT LESSON LIST -->
                <div id="view-student-lessons" class="view-section">
                    <h2 class="section-title">Danh sách bài học</h2>
                    <div id="lesson-list" class="lesson-grid">
                        <!-- Lessons injected here via JS -->
                    </div>
                </div>

                <!-- VIEW: LESSON DETAIL (Khi click vào 1 bài học) -->
                <div id="view-lesson-detail" class="view-section hidden">
                    <button onclick="navigate('student-lessons')" class="btn btn-outline" style="margin-bottom: 20px;">&larr; Quay lại</button>
                    <div class="card">
                        <h1 id="detail-title" style="color: var(--primary-color); margin-bottom: 10px;">Unit Title</h1>
                        <div style="border-bottom: 1px solid #eee; margin-bottom: 20px;"></div>
                        
                        <h3 style="margin-bottom: 10px;"><i class="fa-solid fa-language"></i> Vocabulary</h3>
                        <div id="detail-vocab" style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
                        
                        <h3 style="margin-bottom: 10px;"><i class="fa-solid fa-file-lines"></i> Content</h3>
                        <div id="detail-content" style="line-height: 1.8; margin-bottom: 20px; white-space: pre-wrap;"></div>
                        
                        <div id="detail-video-container"></div>
                    </div>
                </div>

                <!-- VIEW: STUDENT QUIZ GAME -->
                <div id="view-student-quiz" class="view-section hidden">
                    <h2 class="section-title">Mini Game: Thử thách kiến thức</h2>
                    
                    <div id="quiz-start-screen" class="card text-center" style="text-align: center;">
                        <img src="https://cdn-icons-png.flaticon.com/512/3407/3407037.png" width="100" style="margin-bottom: 20px;">
                        <h3>Sẵn sàng chưa?</h3>
                        <p style="color: var(--text-light); margin-bottom: 20px;">Trả lời càng nhiều câu đúng càng tốt để leo Top!</p>
                        <button onclick="startQuiz()" class="btn btn-primary">Bắt đầu ngay</button>
                    </div>

                    <div id="quiz-play-screen" class="hidden quiz-container">
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                <span style="font-weight: bold;">Điểm: <span id="current-score" style="color: var(--primary-color);">0</span></span>
                                <span>Câu hỏi: <span id="question-counter">1</span>/10</span>
                            </div>
                            <div class="progress-bar" style="width: 100%; height: 6px; background: #eee; border-radius: 3px; margin-bottom: 20px;">
                                <div id="quiz-progress" style="width: 0%; height: 100%; background: var(--success); border-radius: 3px; transition: width 0.3s;"></div>
                            </div>
                            
                            <div id="question-text" class="question-box">Câu hỏi sẽ hiện ở đây?</div>
                            
                            <div id="answers-area" class="options-grid">
                                <!-- Options buttons -->
                            </div>
                            
                            <div id="feedback-msg" style="margin-top: 20px; font-weight: bold; height: 24px;"></div>
                            
                            <button id="btn-next-question" onclick="nextQuestion()" class="btn btn-primary hidden" style="margin-top: 20px;">Câu tiếp theo &rarr;</button>
                        </div>
                    </div>
                </div>

                <!-- VIEW: LEADERBOARD -->
                <div id="view-leaderboard" class="view-section hidden">
                    <h2 class="section-title">Bảng vàng thành tích</h2>
                    <div class="card">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>Hạng</th>
                                    <th>Sinh viên</th>
                                    <th>Điểm số</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-body">
                                <!-- Rows injected via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: TEACHER CREATE LESSON -->
                <div id="view-teacher-create-lesson" class="view-section hidden">
                    <h2 class="section-title">Soạn bài giảng mới</h2>
                    <div class="card">
                        <form id="create-lesson-form">
                            <div class="input-group">
                                <label>Tiêu đề bài học (Unit Name)</label>
                                <input type="text" id="lesson-title" class="input-field" placeholder="VD: Unit 1: Electrons" required>
                            </div>
                            <div class="input-group">
                                <label>Mô tả ngắn</label>
                                <input type="text" id="lesson-desc" class="input-field" placeholder="Giới thiệu ngắn gọn..." required>
                            </div>
                            <div class="input-group">
                                <label>Nội dung chi tiết (Essay/Theory)</label>
                                <textarea id="lesson-content" class="input-field" rows="6" placeholder="Nhập nội dung bài giảng..." required></textarea>
                            </div>
                            <div class="input-group">
                                <label>Từ vựng (Vocabulary) - Mỗi dòng 1 từ</label>
                                <textarea id="lesson-vocab" class="input-field" rows="4" placeholder="Word, Pronunciation, Meaning"></textarea>
                                <small style="color: var(--text-light)">Format: Word, /ipa/, Nghĩa (Ví dụ: Atom, /ˈæt.əm/, Nguyên tử)</small>
                            </div>
                            <div class="input-group">
                                <label>Link Video (Youtube Embed URL)</label>
                                <input type="text" id="lesson-video" class="input-field" placeholder="https://www.youtube.com/embed/...">
                            </div>
                            <button type="submit" class="btn btn-primary">Đăng bài</button>
                        </form>
                    </div>
                </div>

                <!-- VIEW: TEACHER CREATE QUIZ -->
                <div id="view-teacher-create-quiz" class="view-section hidden">
                    <h2 class="section-title">Tạo ngân hàng câu hỏi</h2>
                    <div class="card">
                        <form id="create-quiz-form">
                            <div class="input-group">
                                <label>Câu hỏi</label>
                                <input type="text" id="quiz-question" class="input-field" placeholder="Nhập câu hỏi..." required>
                            </div>
                            
                            <div class="options-grid" style="margin-bottom: 15px;">
                                <div class="input-group">
                                    <label>Đáp án A</label>
                                    <input type="text" id="opt-a" class="input-field" required>
                                </div>
                                <div class="input-group">
                                    <label>Đáp án B</label>
                                    <input type="text" id="opt-b" class="input-field" required>
                                </div>
                                <div class="input-group">
                                    <label>Đáp án C</label>
                                    <input type="text" id="opt-c" class="input-field" required>
                                </div>
                                <div class="input-group">
                                    <label>Đáp án D</label>
                                    <input type="text" id="opt-d" class="input-field" required>
                                </div>
                            </div>

                            <div class="input-group">
                                <label>Đáp án đúng</label>
                                <select id="correct-opt" class="input-field">
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Lưu câu hỏi</button>
                        </form>
                    </div>
                </div>

            </main>
        </div>
    </section>

    <!-- FIREBASE SDK & LOGIC -->
    <script type="module">
        // 1. IMPORT FIREBASE LIBRARIES
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDoc, getDocs, doc, setDoc, query, orderBy, limit, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // 2. FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBPAQ8jldVTwtB_uAzz0-oGcZiUaJ3NeyU",
            authDomain: "ewmp-abc18.firebaseapp.com",
            projectId: "ewmp-abc18",
            storageBucket: "ewmp-abc18.firebasestorage.app",
            messagingSenderId: "416084778745",
            appId: "1:416084778745:web:edb8de27952c3007e24c28",
            measurementId: "G-GVP2MCQNLJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- MANDATORY: Define App ID and Paths ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const PUBLIC_DATA_PATH = `artifacts/${appId}/public/data`;
        
        function getUserProfilePath(userId) {
            return `artifacts/${appId}/users/${userId}/profile`;
        }

        // 3. GLOBAL STATE
        let currentUser = null;
        let currentRole = 'student'; // 'student' or 'teacher'
        let selectedRoleAuth = 'student'; // For login switch

        // 4. UI HELPERS
        const get = (id) => document.getElementById(id);
        const show = (id) => get(id).classList.remove('hidden');
        const hide = (id) => get(id).classList.add('hidden');
        const showToast = (msg) => {
            const t = get('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        const toggleLoading = (isLoading) => {
            isLoading ? get('loading-overlay').style.display = 'flex' : get('loading-overlay').style.display = 'none';
        }

        // 5. NAVIGATION LOGIC
        window.switchAuthRole = (role) => {
            selectedRoleAuth = role;
            document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        window.navigate = (viewId) => {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));

            // Show selected view
            if (viewId === 'student-lessons') {
                show('view-student-lessons');
                fetchLessons();
            } else if (viewId === 'student-quiz') {
                show('view-student-quiz');
                hide('quiz-play-screen');
                show('quiz-start-screen');
            } else if (viewId === 'leaderboard') {
                show('view-leaderboard');
                fetchLeaderboard();
            } else if (viewId === 'teacher-create-lesson') {
                show('view-teacher-create-lesson');
            } else if (viewId === 'teacher-create-quiz') {
                show('view-teacher-create-quiz');
            }

            // Highlight sidebar
            const activeMenu = document.querySelector(`.menu-item[onclick="navigate('${viewId}')"]`);
            if (activeMenu) activeMenu.classList.add('active');
        }

        // 6. AUTHENTICATION LOGIC
        onAuthStateChanged(auth, async (user) => {
            toggleLoading(true);
            if (user) {
                currentUser = user;
                // Fetch User Role from PRIVATE PATH
                try {
                    const userDoc = await getDoc(doc(db, getUserProfilePath(user.uid), "info"));
                    if (userDoc.exists()) {
                        currentRole = userDoc.data().role;
                        setupDashboard(user, currentRole);
                    } else {
                        // Fallback: assume student if no profile found
                        currentRole = 'student';
                        setupDashboard(user, 'student');
                    }
                } catch (e) {
                    console.error("Error fetching profile:", e);
                    // Usually happens if user created but profile save failed.
                    currentRole = 'student';
                    setupDashboard(user, 'student');
                }
            } else {
                show('auth-screen');
                hide('app-dashboard');
            }
            toggleLoading(false);
        });

        function setupDashboard(user, role) {
            hide('auth-screen');
            show('app-dashboard');
            get('user-email').textContent = user.email;
            get('user-badge').textContent = role === 'teacher' ? 'Giáo viên' : 'Sinh viên';
            
            // Show correct sidebar menu
            if (role === 'teacher') {
                show('teacher-menu');
                hide('student-menu');
                window.navigate('teacher-create-lesson');
            } else {
                show('student-menu');
                hide('teacher-menu');
                window.navigate('student-lessons');
            }
        }

        const authForm = get('auth-form');
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = get('email').value;
            const password = get('password').value;
            
            toggleLoading(true);
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast("Đăng nhập thành công!");
            } catch (error) {
                showToast("Lỗi: " + error.message);
                toggleLoading(false);
            }
        });

        // Signup Logic
        get('btn-signup').addEventListener('click', async () => {
            const email = get('email').value;
            const password = get('password').value;
            if (!email || !password) return showToast("Vui lòng nhập Email và Mật khẩu");

            toggleLoading(true);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Save Role to PRIVATE PATH
                await setDoc(doc(db, getUserProfilePath(user.uid), "info"), {
                    email: email,
                    role: selectedRoleAuth,
                    createdAt: new Date()
                });
                
                showToast("Đăng ký thành công!");
                // onAuthStateChanged will handle the rest
            } catch (error) {
                showToast("Đăng ký lỗi: " + error.message);
                toggleLoading(false);
            }
        });

        window.handleLogout = () => {
            signOut(auth).then(() => {
                currentUser = null;
                showToast("Đã đăng xuất");
                location.reload();
            });
        }

        // 7. TEACHER FUNCTIONS
        // Create Lesson (PUBLIC DATA)
        get('create-lesson-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (currentRole !== 'teacher') return;

            toggleLoading(true);
            try {
                await addDoc(collection(db, PUBLIC_DATA_PATH, "lessons"), {
                    title: get('lesson-title').value,
                    desc: get('lesson-desc').value,
                    content: get('lesson-content').value,
                    vocab: get('lesson-vocab').value,
                    video: get('lesson-video').value,
                    author: currentUser.email,
                    createdAt: new Date()
                });
                showToast("Đã đăng bài học mới!");
                get('create-lesson-form').reset();
            } catch (err) {
                showToast("Lỗi: " + err.message);
            }
            toggleLoading(false);
        });

        // Create Quiz (PUBLIC DATA)
        get('create-quiz-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (currentRole !== 'teacher') return;

            toggleLoading(true);
            try {
                await addDoc(collection(db, PUBLIC_DATA_PATH, "quizzes"), {
                    question: get('quiz-question').value,
                    options: {
                        A: get('opt-a').value,
                        B: get('opt-b').value,
                        C: get('opt-c').value,
                        D: get('opt-d').value
                    },
                    correct: get('correct-opt').value,
                    createdAt: new Date()
                });
                showToast("Đã thêm câu hỏi!");
                get('create-quiz-form').reset();
            } catch (err) {
                showToast("Lỗi: " + err.message);
            }
            toggleLoading(false);
        });

        // 8. STUDENT FUNCTIONS
        // Fetch Lessons (PUBLIC DATA)
        async function fetchLessons() {
            toggleLoading(true);
            const listContainer = get('lesson-list');
            listContainer.innerHTML = '';
            
            try {
                const q = query(collection(db, PUBLIC_DATA_PATH, "lessons"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    listContainer.innerHTML = '<p>Chưa có bài học nào.</p>';
                }

                querySnapshot.forEach((doc) => {
                    const d = doc.data();
                    // Create Card UI
                    const card = document.createElement('div');
                    card.className = 'lesson-card';
                    card.innerHTML = `
                        <div class="lesson-img">
                            <i class="fa-solid fa-atom"></i>
                        </div>
                        <div class="lesson-body">
                            <div class="lesson-title">${d.title}</div>
                            <div class="lesson-desc">${d.desc}</div>
                            <button class="btn btn-outline" style="width:100%" onclick="openLesson('${doc.id}')">Học ngay</button>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            } catch (err) {
                console.error(err);
            }
            toggleLoading(false);
        }

        // Open Lesson Detail
        window.openLesson = async (lessonId) => {
            toggleLoading(true);
            try {
                const docRef = doc(db, PUBLIC_DATA_PATH, "lessons", lessonId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    hide('view-student-lessons');
                    show('view-lesson-detail');
                    
                    get('detail-title').textContent = data.title;
                    get('detail-content').textContent = data.content;
                    
                    // Parse Vocab
                    const vocabHtml = data.vocab ? data.vocab.split('\n').map(line => `<div style="padding:5px 0; border-bottom:1px dashed #ddd">${line}</div>`).join('') : 'Không có từ vựng.';
                    get('detail-vocab').innerHTML = vocabHtml;

                    // Video
                    if(data.video) {
                        get('detail-video-container').innerHTML = `<iframe width="100%" height="400" src="${data.video}" frameborder="0" allowfullscreen style="border-radius:8px;"></iframe>`;
                    } else {
                         get('detail-video-container').innerHTML = '';
                    }
                }
            } catch (err) {
                showToast("Lỗi tải bài học");
            }
            toggleLoading(false);
        }

        // 9. QUIZ GAME LOGIC
        let quizQuestions = [];
        let currentQIndex = 0;
        let score = 0;

        window.startQuiz = async () => {
            toggleLoading(true);
            try {
                // Get random 10 questions
                const qSnap = await getDocs(collection(db, PUBLIC_DATA_PATH, "quizzes"));
                let allQ = [];
                qSnap.forEach(doc => allQ.push({id: doc.id, ...doc.data()}));
                
                if (allQ.length === 0) {
                    showToast("Chưa có câu hỏi nào!");
                    toggleLoading(false);
                    return;
                }

                // Shuffle and take 10
                quizQuestions = allQ.sort(() => 0.5 - Math.random()).slice(0, 10);
                currentQIndex = 0;
                score = 0;
                
                hide('quiz-start-screen');
                show('quiz-play-screen');
                renderQuestion();
            } catch (err) {
                showToast("Lỗi tải câu hỏi");
            }
            toggleLoading(false);
        }

        function renderQuestion() {
            const q = quizQuestions[currentQIndex];
            get('current-score').textContent = score;
            get('question-counter').textContent = currentQIndex + 1;
            get('question-text').textContent = q.question;
            
            // Update progress bar
            const progressPercent = ((currentQIndex) / quizQuestions.length) * 100;
            get('quiz-progress').style.width = `${progressPercent}%`;

            const area = get('answers-area');
            area.innerHTML = '';
            get('feedback-msg').textContent = '';
            hide('btn-next-question');

            ['A', 'B', 'C', 'D'].forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerHTML = `<b>${opt}.</b> ${q.options[opt]}`;
                btn.onclick = () => checkAnswer(opt, q.correct, btn);
                area.appendChild(btn);
            });
        }

        function checkAnswer(selected, correct, btnElement) {
            // Disable all buttons
            const btns = document.querySelectorAll('.option-btn');
            btns.forEach(b => {
                b.classList.add('disabled');
                b.onclick = null;
                // Highlight correct answer anyway
                if (b.innerHTML.includes(`<b>${correct}.</b>`)) {
                    b.classList.add('correct');
                }
            });

            if (selected === correct) {
                score += 10;
                get('current-score').textContent = score;
                get('feedback-msg').textContent = "Chính xác! +10 điểm";
                get('feedback-msg').style.color = "var(--success)";
            } else {
                btnElement.classList.add('wrong');
                get('feedback-msg').textContent = "Sai rồi!";
                get('feedback-msg').style.color = "var(--error)";
            }

            show('btn-next-question');
        }

        window.nextQuestion = async () => {
            currentQIndex++;
            if (currentQIndex < quizQuestions.length) {
                renderQuestion();
            } else {
                // End Game
                showToast(`Kết thúc! Điểm của bạn: ${score}`);
                await saveScore(score);
                window.navigate('leaderboard');
            }
        }

        async function saveScore(finalScore) {
            if (!currentUser) return;
            try {
                // Save to PUBLIC DATA for leaderboard
                await addDoc(collection(db, PUBLIC_DATA_PATH, "scores"), {
                    email: currentUser.email,
                    score: finalScore,
                    timestamp: new Date()
                });
            } catch (err) {
                console.error("Lỗi lưu điểm", err);
            }
        }

        // 10. LEADERBOARD LOGIC
        async function fetchLeaderboard() {
            toggleLoading(true);
            const tbody = get('leaderboard-body');
            tbody.innerHTML = '';

            try {
                const q = query(collection(db, PUBLIC_DATA_PATH, "scores"), orderBy("score", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    
                    let rankClass = '';
                    if (rank === 1) rankClass = 'rank-1';
                    if (rank === 2) rankClass = 'rank-2';
                    if (rank === 3) rankClass = 'rank-3';

                    row.innerHTML = `
                        <td class="${rankClass}">#${rank}</td>
                        <td>${data.email.split('@')[0]}</td>
                        <td style="font-weight:bold">${data.score}</td>
                    `;
                    tbody.appendChild(row);
                    rank++;
                });
            } catch (err) {
                showToast("Lỗi tải bảng xếp hạng");
                console.error(err);
            }
            toggleLoading(false);
        }
    </script>
</body>
</html>
